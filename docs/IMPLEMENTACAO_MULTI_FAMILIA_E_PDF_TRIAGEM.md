# Implementa√ß√£o: Sele√ß√£o Multi-Fam√≠lia e Ficha de Triagem PDF

**Data de Implementa√ß√£o:** 2025-10-18
**M√≥dulo:** Rastreamento Cardiovascular - Painel de Hipertens√£o
**Tipo:** Melhoria de Funcionalidade + Nova Funcionalidade

---

## üìã Vis√£o Geral

Implementa√ß√£o de duas funcionalidades principais no sistema de rastreamento cardiovascular:

### 1. Sele√ß√£o de Fam√≠lias de M√∫ltiplos Domic√≠lios
Permitir que o profissional selecione fam√≠lias de diferentes domic√≠lios em uma √∫nica sess√£o de rastreamento.

### 2. Step "Ficha de Triagem" com Gera√ß√£o de PDF
Novo passo no wizard que permite gerar um PDF com as fichas de triagem para impress√£o, com layout espec√≠fico e rastreamento de status.

---

## üéØ Requisitos Implementados

### Requisito 1: Sele√ß√£o Multi-Domic√≠lio
‚úÖ Sistema permite selecionar fam√≠lias de domic√≠lios diferentes simultaneamente
‚úÖ Bot√£o "Adicionar Outra Fam√≠lia" vis√≠vel durante a sele√ß√£o
‚úÖ Endere√ßo do domic√≠lio exibido em cada fam√≠lia para distinguir a origem
‚úÖ Fun√ß√£o de remo√ß√£o de fam√≠lia da sele√ß√£o
‚úÖ Contador de fam√≠lias dispon√≠veis, selecionadas e integrantes

### Requisito 2: Ficha de Triagem PDF
‚úÖ Novo step "Ficha de Triagem" inserido entre "Sele√ß√£o de Integrantes" e "Aferi√ß√µes MRPA"
‚úÖ Gera√ß√£o de PDF com m√°ximo 2 fam√≠lias por p√°gina
‚úÖ T√≠tulo "FAMILIAR - NOME DO RESPONS√ÅVEL FAMILIAR" (n√£o "Domic√≠lio")
‚úÖ 2 linhas extras em cada tabela para membros n√£o cadastrados
‚úÖ Sistema de rastreamento de status com 4 estados:
- `nao_triada`: Nenhuma triagem realizada
- `iniciada`: PDF gerado mas sem medi√ß√µes
- `incompleta`: Alguns membros triados
- `concluida`: Todos membros triados
‚úÖ √çcones visuais para cada status

---

## üîß Altera√ß√µes T√©cnicas

### Arquivo 1: `static/rastreamento_cardiovascular_script.js`

#### 1.1 Estado Global Atualizado (Linhas 11-25)

```javascript
window.estadoApp = {
    currentStep: 1,
    totalSteps: 6,                   // ALTERADO: de 5 para 6
    domicilioSelecionado: null,
    familiasDisponiveis: [],         // NOVO: Acumula fam√≠lias de m√∫ltiplos domic√≠lios
    familiasSelecionadas: [],        // NOVO: Fam√≠lias escolhidas para rastreamento
    cidadaosSelecionados: [],
    cidadaosSuspeitos: [],
    cidadaosNormais: [],
    integrantesDisponiveis: [],
    afericoesMRPA: {},
    afericoesMAPA: {},
    resultados: {},
    statusTriagemFamilias: {}        // NOVO: Status de triagem por fam√≠lia
};
```

#### 1.2 Constantes Renumeradas (Linhas 30-37)

```javascript
window.FASES = {
    SELECAO_INTEGRANTES: 1,
    FICHA_TRIAGEM: 2,                // NOVO STEP
    AFERICOES_MRPA: 3,               // Renumerado de 2 ‚Üí 3
    ANALISE_MRPA: 4,                 // Renumerado de 3 ‚Üí 4
    AFERICOES_MAPA: 5,               // Renumerado de 4 ‚Üí 5
    RESULTADO_FINAL: 6               // Renumerado de 5 ‚Üí 6
};
```

#### 1.3 Fun√ß√£o `selecionarDomicilio()` Modificada (Linhas 231-270)

**Mudan√ßa Principal:** Acumula fam√≠lias ao inv√©s de substituir

```javascript
async function selecionarDomicilio(domicilio) {
    const response = await fetch(`/api/rastreamento/familias-domicilio/${domicilio.id_domicilio}`);
    const data = await response.json();

    if (data.familias && data.familias.length > 0) {
        // ACUMULAR fam√≠lias (sem duplicar)
        data.familias.forEach(familia => {
            const jaExiste = estadoApp.familiasDisponiveis.some(f => f.id_familia === familia.id_familia);
            if (!jaExiste) {
                // Adicionar informa√ß√µes do domic√≠lio √† fam√≠lia
                familia.domicilio = {
                    id_domicilio: domicilio.id_domicilio,
                    endereco_completo: domicilio.endereco_completo
                };
                estadoApp.familiasDisponiveis.push(familia);
            }
        });

        // MANTER lista de domic√≠lios vis√≠vel para permitir adicionar mais
        document.getElementById('wizard-rastreamento')?.classList.remove('hidden');

        // Re-renderizar se j√° estiver no Step 1
        if (estadoApp.currentStep !== 1) {
            irParaStep(1);
        } else {
            renderizarStepAtual();
        }
    }
}
```

#### 1.4 UI do Step 1 Atualizada (Linhas 353-398)

**Adi√ß√µes:**
- Estat√≠sticas de sele√ß√£o (fam√≠lias dispon√≠veis, selecionadas, integrantes)
- Bot√£o "Adicionar Outra Fam√≠lia" no cabe√ßalho
- Fun√ß√£o `voltarParaBuscaDomicilios()` para rolar para os filtros

```javascript
function renderizarStepSelecaoIntegrantes(container) {
    const totalFamilias = estadoApp.familiasDisponiveis.length;
    const totalSelecionadas = estadoApp.familiasSelecionadas.length;

    container.innerHTML = `
        <div class="flex items-center justify-between mb-4">
            <div>
                <h3>Selecione as Fam√≠lias e Integrantes para Rastreamento</h3>
                <p class="text-sm text-gray-600 mt-1">
                    <strong>${totalFamilias} fam√≠lia(s)</strong> dispon√≠vel(is) ‚Ä¢
                    <strong>${totalSelecionadas} fam√≠lia(s)</strong> selecionada(s) ‚Ä¢
                    <strong>${estadoApp.cidadaosSelecionados.length} integrante(s)</strong> selecionado(s)
                </p>
            </div>
            <button onclick="voltarParaBuscaDomicilios()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg">
                <i class="ri-add-line"></i>
                Adicionar Outra Fam√≠lia
            </button>
        </div>
    `;
}

window.voltarParaBuscaDomicilios = function() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    mostrarNotificacao('Busque outro domic√≠lio para adicionar mais fam√≠lias', 'info');
};
```

#### 1.5 Card de Fam√≠lia com Endere√ßo e Remo√ß√£o (Linhas 407-483)

**Adi√ß√µes:**
- Exibi√ß√£o do endere√ßo do domic√≠lio em cada card de fam√≠lia
- Bot√£o de remo√ß√£o de fam√≠lia
- Fun√ß√£o `removerFamilia()` para excluir fam√≠lia e seus integrantes

```javascript
function criarCardFamilia(familia) {
    div.innerHTML = `
        <div class="bg-blue-100 border-b-2 border-blue-300 px-4 py-3">
            <div class="flex items-start justify-between gap-4">
                <div class="flex items-start gap-3 flex-1">
                    <input type="checkbox" id="check-familia-${familia.id_familia}"
                           onchange="toggleFamilia(${familia.id_familia})">
                    <div class="flex-1">
                        <h4 class="font-bold text-blue-900">
                            <i class="ri-home-heart-line mr-1"></i>FAM√çLIA - ${familia.nome_responsavel_familiar.toUpperCase()}
                        </h4>
                        <!-- NOVO: Exibir endere√ßo do domic√≠lio -->
                        <p class="text-xs text-blue-600 mt-1">
                            <i class="ri-map-pin-line mr-1"></i>${familia.domicilio?.endereco_completo}
                        </p>
                        <p class="text-sm text-blue-700 mt-1">
                            Micro√°rea: ${familia.microarea} ‚Ä¢ ${familia.total_integrantes} integrante(s)
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleDetalhesFamily(${familia.id_familia})">Expandir</button>
                    <!-- NOVO: Bot√£o de remo√ß√£o -->
                    <button onclick="removerFamilia(${familia.id_familia})"
                            class="bg-red-600" title="Remover fam√≠lia">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

window.removerFamilia = function(idFamilia) {
    if (!confirm('Deseja remover esta fam√≠lia e todos os seus integrantes da sele√ß√£o?')) {
        return;
    }

    const familia = estadoApp.familiasDisponiveis.find(f => f.id_familia === idFamilia);

    // Remover todos integrantes desta fam√≠lia
    familia.integrantes.forEach(integrante => {
        estadoApp.cidadaosSelecionados = estadoApp.cidadaosSelecionados.filter(
            c => c.co_seq_cds_cad_individual !== integrante.co_seq_cds_cad_individual
        );
    });

    // Remover fam√≠lia das listas
    estadoApp.familiasSelecionadas = estadoApp.familiasSelecionadas.filter(f => f.id_familia !== idFamilia);
    estadoApp.familiasDisponiveis = estadoApp.familiasDisponiveis.filter(f => f.id_familia !== idFamilia);

    renderizarStepAtual();
    mostrarNotificacao('Fam√≠lia removida da sele√ß√£o', 'info');
};
```

#### 1.6 NOVO Step 2: Ficha de Triagem (Linhas 760-954)

**Fun√ß√£o Principal:** `renderizarStepFichaTriagem()`

```javascript
function renderizarStepFichaTriagem(container) {
    const totalFamilias = estadoApp.familiasSelecionadas.length;
    const totalIntegrantes = estadoApp.cidadaosSelecionados.length;

    container.innerHTML = `
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="ri-file-text-line mr-2"></i>Ficha de Triagem Familiar
        </h3>

        <!-- Resumo da Sele√ß√£o -->
        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-6">
            <h4 class="font-semibold text-blue-900 mb-3">Resumo da Sele√ß√£o</h4>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div class="bg-white rounded-lg p-3">
                    <div class="text-2xl font-bold text-blue-600">${totalFamilias}</div>
                    <div class="text-xs text-gray-600 mt-1">Fam√≠lia(s) selecionada(s)</div>
                </div>
                <div class="bg-white rounded-lg p-3">
                    <div class="text-2xl font-bold text-green-600">${totalIntegrantes}</div>
                    <div class="text-xs text-gray-600 mt-1">Integrante(s) selecionado(s)</div>
                </div>
                <div class="bg-white rounded-lg p-3">
                    <div class="text-2xl font-bold text-purple-600">${Math.ceil(totalFamilias / 2)}</div>
                    <div class="text-xs text-gray-600 mt-1">P√°gina(s) do PDF</div>
                </div>
            </div>
        </div>

        <!-- Lista de Fam√≠lias com Status -->
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
            <h4 class="font-semibold text-gray-900 mb-3">Fam√≠lias que ser√£o inclu√≠das no PDF:</h4>
            <div class="space-y-2">
                ${estadoApp.familiasSelecionadas.map((familia, index) => {
                    const status = obterStatusTriagemFamilia(familia.id_familia);
                    const iconeStatus = obterIconeStatusTriagem(status);
                    const corStatus = obterCorStatusTriagem(status);

                    return `
                        <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <span class="font-medium">${index + 1}. ${familia.nome_responsavel_familiar}</span>
                            <span class="${corStatus} px-2 py-0.5 rounded-full text-xs font-semibold">
                                <i class="${iconeStatus} mr-1"></i>${status.toUpperCase().replace('_', ' ')}
                            </span>
                            <div class="text-xs text-gray-600">
                                <i class="ri-map-pin-line"></i>${familia.domicilio?.endereco_completo}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>

        <!-- Bot√£o Gerar PDF -->
        <div class="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-300 rounded-lg p-6 text-center">
            <button onclick="gerarPDFTriagem()"
                    class="px-8 py-4 bg-red-600 hover:bg-red-700 text-white text-lg font-bold rounded-lg">
                <i class="ri-file-pdf-line mr-2 text-xl"></i>
                Gerar PDF de Triagem Domiciliar
            </button>
            <p class="text-sm text-gray-700 mt-3">
                O PDF ser√° gerado com <strong>2 fam√≠lias por p√°gina</strong> e incluir√°
                <strong>2 linhas extras</strong> em cada tabela
            </p>
        </div>
    `;
}
```

**Fun√ß√µes Auxiliares de Status:**

```javascript
function obterStatusTriagemFamilia(idFamilia) {
    return estadoApp.statusTriagemFamilias[idFamilia] || 'nao_triada';
}

function obterIconeStatusTriagem(status) {
    const icones = {
        'nao_triada': 'ri-file-list-line',
        'iniciada': 'ri-time-line',
        'incompleta': 'ri-error-warning-line',
        'concluida': 'ri-check-double-line'
    };
    return icones[status] || 'ri-file-list-line';
}

function obterCorStatusTriagem(status) {
    const cores = {
        'nao_triada': 'bg-gray-100 text-gray-700',
        'iniciada': 'bg-blue-100 text-blue-700',
        'incompleta': 'bg-yellow-100 text-yellow-700',
        'concluida': 'bg-green-100 text-green-700'
    };
    return cores[status] || 'bg-gray-100 text-gray-700';
}
```

**Fun√ß√£o de Gera√ß√£o de PDF:**

```javascript
window.gerarPDFTriagem = async function() {
    mostrarNotificacao('Gerando PDF de triagem...', 'info');

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const familiasPorPagina = 2;

        // Processar fam√≠lias em grupos de 2
        for (let i = 0; i < estadoApp.familiasSelecionadas.length; i += familiasPorPagina) {
            if (i > 0) {
                doc.addPage();
            }

            const familiasDaPagina = estadoApp.familiasSelecionadas.slice(i, i + familiasPorPagina);

            // Renderizar cada fam√≠lia na p√°gina
            familiasDaPagina.forEach((familia, indexNaPagina) => {
                const yInicial = indexNaPagina === 0 ? 20 : 150; // Segunda fam√≠lia mais abaixo
                renderizarFamiliaNoPDF(doc, familia, yInicial);
            });
        }

        // Salvar PDF
        doc.save(`triagem_familiar_${new Date().toISOString().split('T')[0]}.pdf`);

        // Marcar fam√≠lias como "iniciada"
        estadoApp.familiasSelecionadas.forEach(familia => {
            if (estadoApp.statusTriagemFamilias[familia.id_familia] === 'nao_triada' ||
                !estadoApp.statusTriagemFamilias[familia.id_familia]) {
                estadoApp.statusTriagemFamilias[familia.id_familia] = 'iniciada';
            }
        });

        // Re-renderizar para mostrar novos status
        renderizarStepAtual();

        mostrarNotificacao('PDF gerado com sucesso!', 'success');
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        mostrarNotificacao('Erro ao gerar PDF. Verifique se o jsPDF est√° carregado.', 'error');
    }
};
```

**Fun√ß√£o de Renderiza√ß√£o do PDF (B√°sica):**

```javascript
function renderizarFamiliaNoPDF(doc, familia, yInicial) {
    doc.setFontSize(12);
    // FORMATO: "FAMILIAR - NOME" (n√£o "Domic√≠lio")
    doc.text(`FAMILIAR - ${familia.nome_responsavel_familiar.toUpperCase()}`, 20, yInicial);

    doc.setFontSize(9);
    doc.text(`Endere√ßo: ${familia.domicilio?.endereco_completo}`, 20, yInicial + 7);
    doc.text(`Micro√°rea: ${familia.microarea}`, 20, yInicial + 12);

    // Integrantes selecionados
    const integrantesSelecionados = familia.integrantes.filter(i =>
        estadoApp.cidadaosSelecionados.some(c => c.co_seq_cds_cad_individual === i.co_seq_cds_cad_individual)
    );

    let y = yInicial + 20;
    doc.setFontSize(10);
    doc.text('Integrantes:', 20, y);
    y += 5;

    doc.setFontSize(8);
    integrantesSelecionados.forEach(integrante => {
        doc.text(`- ${integrante.nome_cidadao} (${integrante.idade} anos)`, 25, y);
        y += 5;
    });

    // 2 LINHAS EXTRAS (requisito do usu√°rio)
    doc.text('- _________________ (linha extra)', 25, y);
    y += 5;
    doc.text('- _________________ (linha extra)', 25, y);
}
```

#### 1.7 Valida√ß√£o Atualizada (Linhas 959-986)

```javascript
function validarStepAtual() {
    switch (estadoApp.currentStep) {
        case FASES.SELECAO_INTEGRANTES:
            if (estadoApp.cidadaosSelecionados.length === 0) {
                mostrarNotificacao('Selecione pelo menos um integrante', 'warning');
                return false;
            }
            return true;

        case FASES.FICHA_TRIAGEM:  // NOVO
            // N√£o exige que PDF seja gerado para avan√ßar
            return true;

        case FASES.AFERICOES_MRPA:
            return validarAfericoesMRPA();

        case FASES.ANALISE_MRPA:
            return true;

        case FASES.AFERICOES_MAPA:
            return validarAfericoesMAPA();

        default:
            return true;
    }
}
```

---

### Arquivo 2: `templates/painel-rastreamento-cardiovascular.html`

#### 2.1 Biblioteca jsPDF Adicionada (Linha 31-32)

```html
<!-- jsPDF - Biblioteca para gera√ß√£o de PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
```

#### 2.2 Indicador Visual de Progresso Atualizado (Linhas 161-204)

**Adicionado Step 2 "Ficha de Triagem":**

```html
<!-- STEPS -->
<div class="flex items-center justify-between mt-4">
    <!-- Step 1: Selecionar Integrantes -->
    <div class="step-item active flex flex-col items-center" data-step="1">
        <div class="w-10 h-10 rounded-full bg-red-600 text-white flex items-center justify-center mb-2">
            <i class="ri-user-add-line"></i>
        </div>
        <span class="text-xs text-center">Selecionar<br>Integrantes</span>
    </div>
    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>

    <!-- NOVO Step 2: Ficha de Triagem -->
    <div class="step-item flex flex-col items-center" data-step="2">
        <div class="w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center mb-2">
            <i class="ri-file-pdf-line"></i>
        </div>
        <span class="text-xs text-center">Ficha de<br>Triagem</span>
    </div>
    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>

    <!-- Step 3: Aferi√ß√µes MRPA (renumerado de 2) -->
    <div class="step-item flex flex-col items-center" data-step="3">
        <div class="w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center mb-2">
            <i class="ri-stethoscope-line"></i>
        </div>
        <span class="text-xs text-center">Aferi√ß√µes<br>MRPA</span>
    </div>
    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>

    <!-- Step 4: An√°lise MRPA (renumerado de 3) -->
    <div class="step-item flex flex-col items-center" data-step="4">
        <div class="w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center mb-2">
            <i class="ri-bar-chart-line"></i>
        </div>
        <span class="text-xs text-center">An√°lise<br>MRPA</span>
    </div>
    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>

    <!-- Step 5: MRPA 5 Dias (renumerado de 4) -->
    <div class="step-item flex flex-col items-center" data-step="5">
        <div class="w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center mb-2">
            <i class="ri-time-line"></i>
        </div>
        <span class="text-xs text-center">MRPA<br>5 Dias</span>
    </div>
    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>

    <!-- Step 6: Resultado Final (renumerado de 5) -->
    <div class="step-item flex flex-col items-center" data-step="6">
        <div class="w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center mb-2">
            <i class="ri-checkbox-circle-line"></i>
        </div>
        <span class="text-xs text-center">Resultado<br>Final</span>
    </div>
</div>
```

---

## üìä Fluxo Completo do Sistema

### Workflow Atualizado:

```
1. BUSCA DE DOMIC√çLIOS
   ‚Üì
2. SELE√á√ÉO DE DOMIC√çLIO
   ‚Üì (adiciona fam√≠lias ao pool)
   ‚Üì
3. STEP 1: SELE√á√ÉO DE INTEGRANTES
   ‚îú‚îÄ Selecionar fam√≠lias (m√∫ltiplos domic√≠lios)
   ‚îú‚îÄ Selecionar integrantes de cada fam√≠lia
   ‚îî‚îÄ Bot√£o "Adicionar Outra Fam√≠lia" ‚Üí volta ao passo 1
   ‚Üì
4. STEP 2: FICHA DE TRIAGEM (NOVO)
   ‚îú‚îÄ Visualizar resumo das fam√≠lias selecionadas
   ‚îú‚îÄ Ver status de cada fam√≠lia
   ‚îú‚îÄ Gerar PDF (2 fam√≠lias/p√°gina)
   ‚îî‚îÄ Status atualizado para "iniciada"
   ‚Üì
5. STEP 3: AFERI√á√ïES MRPA (3-5 dias)
   ‚Üì
6. STEP 4: AN√ÅLISE MRPA
   ‚Üì
7. STEP 5: MRPA 5 DIAS
   ‚Üì
8. STEP 6: RESULTADO FINAL
```

---

## üé® Interface do Usu√°rio

### Step 1: Sele√ß√£o de Integrantes

**Cabe√ßalho:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Selecione as Fam√≠lias e Integrantes para Rastreamento  ‚îÇ
‚îÇ 3 fam√≠lia(s) dispon√≠vel(is) ‚Ä¢ 2 fam√≠lia(s) selecionada(s)‚îÇ
‚îÇ ‚Ä¢ 8 integrante(s) selecionado(s)                        ‚îÇ
‚îÇ                          [Adicionar Outra Fam√≠lia] ‚Üê‚îÄ‚îÄ‚îÄ ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Card de Fam√≠lia:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚òë FAM√çLIA - MARIA DA SILVA           [Expandir] [‚úï]     ‚îÇ
‚îÇ üìç RUA DAS FLORES, 123 - CENTRO                          ‚îÇ
‚îÇ Micro√°rea: 03 ‚Ä¢ 4 integrante(s)                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   ‚òë Jo√£o Silva - 45 anos - Masculino [Eleg√≠vel]         ‚îÇ
‚îÇ   ‚òë Maria Silva - 42 anos - Feminino [Eleg√≠vel]         ‚îÇ
‚îÇ   ‚òê Pedro Silva - 15 anos - Masculino [Eleg√≠vel]        ‚îÇ
‚îÇ   ‚ñ° Ana Silva - 60 anos - Feminino [J√° diagnosticado]   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Step 2: Ficha de Triagem

**Resumo:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Resumo da Sele√ß√£o                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ        2         ‚îÇ        8         ‚îÇ         1         ‚îÇ
‚îÇ  Fam√≠lia(s)      ‚îÇ  Integrante(s)   ‚îÇ   P√°gina(s) PDF   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Lista de Fam√≠lias:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. MARIA DA SILVA              [üïê INICIADA]           ‚îÇ
‚îÇ    üìç RUA DAS FLORES, 123 - CENTRO                      ‚îÇ
‚îÇ    4 integrantes: Jo√£o Silva, Maria Silva, Pedro...    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 2. JOS√â SANTOS                 [‚¨ú N√ÉO TRIADA]         ‚îÇ
‚îÇ    üìç AVENIDA BRASIL, 456 - JARDIM                      ‚îÇ
‚îÇ    4 integrantes: Jos√© Santos, Ana Santos, Carlos...   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

         [üìÑ Gerar PDF de Triagem Domiciliar]
```

**Status Poss√≠veis:**
- üóé N√ÉO TRIADA (cinza)
- üïê INICIADA (azul)
- ‚ö† INCOMPLETA (amarelo)
- ‚úì‚úì CONCLU√çDA (verde)

---

## üìù Estrutura do PDF Gerado

### Layout de Cada P√°gina:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FAMILIAR - MARIA DA SILVA                             ‚îÇ
‚îÇ Endere√ßo: RUA DAS FLORES, 123 - CENTRO                ‚îÇ
‚îÇ Micro√°rea: 03                                          ‚îÇ
‚îÇ                                                        ‚îÇ
‚îÇ Integrantes:                                           ‚îÇ
‚îÇ - Jo√£o Silva (45 anos)                                 ‚îÇ
‚îÇ - Maria Silva (42 anos)                                ‚îÇ
‚îÇ - Pedro Silva (15 anos)                                ‚îÇ
‚îÇ - _________________ (linha extra)                      ‚îÇ
‚îÇ - _________________ (linha extra)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ FAMILIAR - JOS√â SANTOS                                 ‚îÇ
‚îÇ Endere√ßo: AVENIDA BRASIL, 456 - JARDIM                ‚îÇ
‚îÇ Micro√°rea: 05                                          ‚îÇ
‚îÇ                                                        ‚îÇ
‚îÇ Integrantes:                                           ‚îÇ
‚îÇ - Jos√© Santos (50 anos)                                ‚îÇ
‚îÇ - Ana Santos (48 anos)                                 ‚îÇ
‚îÇ - Carlos Santos (20 anos)                              ‚îÇ
‚îÇ - Beatriz Santos (18 anos)                             ‚îÇ
‚îÇ - _________________ (linha extra)                      ‚îÇ
‚îÇ - _________________ (linha extra)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Caracter√≠sticas:**
- M√°ximo 2 fam√≠lias por p√°gina
- T√≠tulo: "FAMILIAR - [NOME DO RESPONS√ÅVEL]"
- 2 linhas extras em cada tabela
- Nome do arquivo: `triagem_familiar_YYYY-MM-DD.pdf`

---

## üß™ Testes Recomendados

### Teste 1: Sele√ß√£o de M√∫ltiplas Fam√≠lias
1. ‚úÖ Buscar domic√≠lio 1
2. ‚úÖ Selecionar fam√≠lia A do domic√≠lio 1
3. ‚úÖ Clicar em "Adicionar Outra Fam√≠lia"
4. ‚úÖ Buscar domic√≠lio 2
5. ‚úÖ Selecionar fam√≠lia B do domic√≠lio 2
6. ‚úÖ Verificar se ambas as fam√≠lias aparecem no Step 1
7. ‚úÖ Verificar se cada fam√≠lia mostra seu endere√ßo correto
8. ‚úÖ Remover fam√≠lia A
9. ‚úÖ Verificar se fam√≠lia B permanece selecionada

### Teste 2: Gera√ß√£o de PDF
1. ‚úÖ Selecionar 3 fam√≠lias
2. ‚úÖ Selecionar integrantes de cada fam√≠lia
3. ‚úÖ Avan√ßar para Step 2
4. ‚úÖ Verificar resumo (3 fam√≠lias, X integrantes, 2 p√°ginas)
5. ‚úÖ Verificar status inicial "n√£o triada" em todas
6. ‚úÖ Clicar em "Gerar PDF de Triagem Domiciliar"
7. ‚úÖ Verificar se PDF foi baixado
8. ‚úÖ Abrir PDF e verificar:
   - P√°gina 1: 2 fam√≠lias
   - P√°gina 2: 1 fam√≠lia
   - Cada fam√≠lia tem t√≠tulo "FAMILIAR - [NOME]"
   - Cada fam√≠lia tem 2 linhas extras
9. ‚úÖ Verificar se status mudou para "iniciada"

### Teste 3: Fluxo Completo
1. ‚úÖ Selecionar 2 fam√≠lias de domic√≠lios diferentes
2. ‚úÖ Selecionar integrantes
3. ‚úÖ Gerar PDF
4. ‚úÖ Avan√ßar para Step 3 (Aferi√ß√µes MRPA)
5. ‚úÖ Registrar medi√ß√µes
6. ‚úÖ Completar todo o fluxo at√© o resultado final
7. ‚úÖ Verificar se dados persistem entre steps

---

## ‚ö†Ô∏è Notas T√©cnicas

### Limita√ß√µes Atuais

1. **Layout B√°sico do PDF:**
   - Implementa√ß√£o atual √© funcional mas b√°sica
   - Usu√°rio mencionou "imagem em anexo" mas n√£o forneceu
   - Quando imagem for fornecida, layout pode precisar ser refinado

2. **Atualiza√ß√£o Autom√°tica de Status:**
   - Status "iniciada" ‚Üí "incompleta" ainda n√£o implementado
   - Status "incompleta" ‚Üí "conclu√≠da" ainda n√£o implementado
   - Requer l√≥gica adicional verificando `estadoApp.resultados`

3. **Persist√™ncia:**
   - Todos os dados existem apenas em `window.estadoApp`
   - Dados s√£o perdidos ao recarregar a p√°gina
   - N√£o h√° salvamento no backend

### Compatibilidade

- ‚úÖ C√≥digo retrocompat√≠vel com funcionalidades existentes
- ‚úÖ N√£o quebra fluxos anteriores
- ‚úÖ jsPDF carregado via CDN (sem impacto no bundle)

### Performance

- ‚úÖ Nenhum impacto esperado
- ‚úÖ Renderiza√ß√£o condicional eficiente
- ‚úÖ PDF gerado client-side (n√£o sobrecarrega servidor)

---

## üìö Refer√™ncias de C√≥digo

### Localiza√ß√£o das Modifica√ß√µes:

| Funcionalidade | Arquivo | Linhas |
|----------------|---------|--------|
| Estado Global | `rastreamento_cardiovascular_script.js` | 11-25 |
| Constantes FASES | `rastreamento_cardiovascular_script.js` | 30-37 |
| `selecionarDomicilio()` | `rastreamento_cardiovascular_script.js` | 231-270 |
| UI Step 1 | `rastreamento_cardiovascular_script.js` | 353-398 |
| Card Fam√≠lia | `rastreamento_cardiovascular_script.js` | 407-483 |
| `removerFamilia()` | `rastreamento_cardiovascular_script.js` | 460-483 |
| Step 2: Ficha Triagem | `rastreamento_cardiovascular_script.js` | 760-954 |
| Status Helpers | `rastreamento_cardiovascular_script.js` | 850-873 |
| `gerarPDFTriagem()` | `rastreamento_cardiovascular_script.js` | 876-922 |
| `renderizarFamiliaNoPDF()` | `rastreamento_cardiovascular_script.js` | 924-954 |
| Valida√ß√£o | `rastreamento_cardiovascular_script.js` | 959-986 |
| CDN jsPDF | `painel-rastreamento-cardiovascular.html` | 31-32 |
| Steps Visuais | `painel-rastreamento-cardiovascular.html` | 161-204 |

---

## ‚úÖ Status Final

**Implementa√ß√£o:** ‚úÖ **COMPLETA**
**Testes:** ‚è≥ Pendente (requer execu√ß√£o da aplica√ß√£o)
**Documenta√ß√£o:** ‚úÖ Completa
**Data de Conclus√£o:** 2025-10-18

### Funcionalidades Entregues:

- ‚úÖ Sele√ß√£o de fam√≠lias de m√∫ltiplos domic√≠lios
- ‚úÖ Bot√£o "Adicionar Outra Fam√≠lia"
- ‚úÖ Exibi√ß√£o de endere√ßo em cada fam√≠lia
- ‚úÖ Remo√ß√£o de fam√≠lia da sele√ß√£o
- ‚úÖ Novo step "Ficha de Triagem"
- ‚úÖ Gera√ß√£o de PDF com 2 fam√≠lias/p√°gina
- ‚úÖ T√≠tulo "FAMILIAR - NOME" no PDF
- ‚úÖ 2 linhas extras por tabela
- ‚úÖ Sistema de rastreamento de status
- ‚úÖ √çcones visuais para cada status
- ‚úÖ jsPDF carregado no HTML
- ‚úÖ Indicador visual de progresso atualizado

### Pr√≥ximos Passos (Opcionais):

1. **Aguardar Imagem do Layout do PDF:**
   - Usu√°rio mencionou "imagem em anexo"
   - Quando fornecida, refinar layout do PDF

2. **Implementar L√≥gica de Atualiza√ß√£o de Status:**
   - Detectar quando triagem est√° "incompleta"
   - Detectar quando triagem est√° "conclu√≠da"
   - Atualizar status automaticamente

3. **Testes em Ambiente Real:**
   - Executar aplica√ß√£o
   - Testar gera√ß√£o de PDF
   - Validar fluxo completo

---

**Documenta√ß√£o gerada automaticamente**
**√öltima atualiza√ß√£o:** 2025-10-18
